#!/bin/bash

### This script is called after the user installs the application.
# 使用向导产生的环境变量生成配置文件config.yml，配置文件放置在$TRIM_PKGETC/config.yml

# 检查必要的环境变量
if [ -z "$TRIM_PKGETC" ]; then
    echo "Error: TRIM_PKGETC environment variable is not set"
    exit 1
fi

# 创建配置目录
mkdir -p "$TRIM_PKGETC"

# 如果配置文件已存在，先删除
if [ -f "$TRIM_PKGETC/config.yml" ]; then
    rm -f "$TRIM_PKGETC/config.yml"
fi

# 读取向导产生的环境变量
ADMIN_USERNAME="${wizard_admin_username:-admin}"
ADMIN_PASSWORD="${wizard_admin_password:-}"
DATABASE_TYPE="${wizard_database_type:-sqlite}"
POSTGRES_HOST="${wizard_postgres_host:-127.0.0.1}"
POSTGRES_PORT="${wizard_postgres_port:-5432}"
POSTGRES_USERNAME="${wizard_postgres_username:-qms}"
POSTGRES_PASSWORD="${wizard_postgres_password:-qms123456}"
POSTGRES_DATABASE="${wizard_postgres_database:-qms}"

# 生成配置文件
cat > "$TRIM_PKGETC/config.yml" << 'EOF'
log:
  file: logs/app.log
  v115: logs/115.log
  openList: logs/openList.log
  tmdb: logs/tmdb.log
  baiduPan: logs/baidupan.log
  web: logs/web.log
  syncLogDir: logs/sync
db:
EOF

# 根据数据库类型生成相应的配置
if [ "$DATABASE_TYPE" = "sqlite" ]; then
    cat >> "$TRIM_PKGETC/config.yml" << 'EOF'
  engine: sqlite
  sqliteFile: qmediasync.db
  postgresType: external
  postgresConfig:
    host: "localhost"
    port: 5432
    user: "qms"
    password: "qms123456"
    database: "qms"
    maxOpenConns: 25
    maxIdleConns: 25
EOF
else
    cat >> "$TRIM_PKGETC/config.yml" << EOF
  engine: postgres
  sqliteFile: qmediasync.db
  postgresType: external
  postgresConfig:
    host: $POSTGRES_HOST
    port: $POSTGRES_PORT
    user: $POSTGRES_USERNAME
    password: "$POSTGRES_PASSWORD"
    database: $POSTGRES_DATABASE
    maxOpenConns: 25
    maxIdleConns: 25
EOF
fi

# 添加其他默认配置
cat >> "$TRIM_PKGETC/config.yml" << EOF
cacheSize: 20971520
jwtSecret: Q115-STRM-JWT-TOKEN-250706
httpHost: :12333
httpsHost: :12332
strm:
  videoExt: []
  minVideoSize: 0
  metaExt: []
  cron: ""
authServer: https://api.mqfamily.top
baiDuPanAppId: QMediaSync
adminUsername: $ADMIN_USERNAME
adminPassword: $ADMIN_PASSWORD
EOF

echo "Configuration file created at $TRIM_PKGETC/config.yml"
echo "Database type: $DATABASE_TYPE"
echo "Application port: $APP_PORT"
echo "Admin username: $ADMIN_USERNAME"

exit 0